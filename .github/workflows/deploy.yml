name: Deploy to AWS (Trivy -> ECR -> EC2 via SSM)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  ECR_REPO_FRONTEND: ${{ secrets.ECR_REPO_FRONTEND }}
  ECR_REPO_BACKEND: ${{ secrets.ECR_REPO_BACKEND }}
  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}

jobs:
  sec-repo:
    name: Trivy repo scan (code + IaC + secrets)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trivy repository scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scanners: vuln,misconfig,secret
          format: sarif
          output: trivy-repo.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: Upload SARIF (repo)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-repo.sarif
          category: trivy-repo

  build-deploy:
    name: Build -> Push -> Scan images -> Deploy
    runs-on: ubuntu-latest
    needs: sec-repo
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_REGISTRY"

      - name: Build Docker images
        run: |
          docker build -t "$ECR_REGISTRY/$ECR_REPO_FRONTEND:latest" ./app/frontend
          docker build -t "$ECR_REGISTRY/$ECR_REPO_BACKEND:latest" ./app/backend

      - name: Push Docker images
        run: |
          docker push "$ECR_REGISTRY/$ECR_REPO_FRONTEND:latest"
          docker push "$ECR_REGISTRY/$ECR_REPO_BACKEND:latest"

      - name: Trivy image scan (frontend)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO_FRONTEND }}:latest
          format: sarif
          output: trivy-frontend.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: Upload frontend SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-frontend.sarif
          category: trivy-frontend

      - name: Trivy image scan (backend)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO_BACKEND }}:latest
          format: sarif
          output: trivy-backend.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: Upload backend SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-backend.sarif
          category: trivy-backend

      - name: Deploy to EC2 via SSM
        run: |
          CMD_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Pull latest images & restart containers" \
            --parameters 'commands=[
              "sudo docker compose -f /opt/app/docker-compose.yml pull",
              "sudo docker compose -f /opt/app/docker-compose.yml up -d",
              "sudo docker ps"
            ]' \
            --query "Command.CommandId" --output text)
          echo "SSM Command ID: $CMD_ID"

